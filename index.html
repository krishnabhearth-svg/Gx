<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>üåæ Krishi Dynamic Semantic Search</title>
<style>
body{font-family:Arial,sans-serif;background:#f9f9f9;color:#222;margin:0;padding:20px;text-align:center;}
.container{max-width:800px;margin:0 auto;background:white;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
input{width:90%;max-width:400px;padding:12px;border:1px solid #ccc;border-radius:20px;font-size:1em;margin:15px 0;}
.action-box{background:#e8f5e8;padding:15px;border-radius:10px;margin:20px 0;text-align:left;}
.action-item{display:inline-block;background:white;padding:6px 12px;margin:4px 6px 4px 0;border-radius:16px;font-size:0.85em;}
.result a{color:#1a73e8;text-decoration:none;font-weight:600;}
.tabs{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin:15px 0;}
.tab{padding:8px 16px;background:#e0e0e0;border:none;border-radius:20px;cursor:pointer;font-size:0.8em;}
.tab.active{background:#4CAF50;color:white;}
.panel{display:none;text-align:left;margin-top:15px;padding:15px;background:#fff;border-radius:8px;}
.panel.active{display:block;}
.status{font-size:0.8em;color:#666;margin-top:5px;}
</style>
</head>
<body>
<div class="container">
  <h1>üåæ Krishi ‚Ä¢ Dynamic Semantic Search</h1>
  <p>Type any keyword (e.g., "pollution vehicle", "organic farming")</p>
  <input type="text" id="userQuery" placeholder="e.g., water conservation‚Ä¶" oninput="handleSearch()" autocomplete="off">

  <div id="actionsBox" class="action-box" style="display:none;">
    <strong>Recommended Actions:</strong><br>
    <div id="actionItems"></div>
  </div>

  <div class="tabs" id="tabs">
    <div class="tab active" data-target="ecological">Ecological</div>
    <div class="tab" data-target="gap">Gap Analysis</div>
    <div class="tab" data-target="action">Action</div>
    <div class="tab" data-target="all">All Tabs</div>
  </div>

  <div id="panels">
    <div class="panel active" id="ecological"><h3>üå± Ecological Search</h3><div id="ecologicalLink"></div></div>
    <div class="panel" id="gap"><h3>üîç Gap/Challenge Search</h3><div id="gapLink"></div></div>
    <div class="panel" id="action"><h3>‚úÖ Action-Oriented Search</h3><div id="actionLink"></div></div>
    <div class="panel" id="all">
      <h3>üåê All Search Results</h3>
      <div id="allResults"></div>
    </div>
  </div>

  <div class="status" id="status">Loading semantic database‚Ä¶</div>
</div>

<script>
// üîó Dynamic JSON Semantic Database URL (host yours on GitHub/GitLab)
const SEMANTIC_DB_URL = 'https://gist.githubusercontent.com/anonymous/000000000000000000000000/raw/semantic-db.json';
// Replace above with your raw JSON URL. For demo, we use embedded fallback.

let semanticDB = null;

// üß† Load Semantic DB
async function loadSemanticDB() {
  try {
    const res = await fetch(SEMANTIC_DB_URL);
    if (res.ok) {
      semanticDB = await res.json();
      document.getElementById('status').textContent = '‚úÖ Semantic DB loaded';
    } else throw 'Network error';
  } catch (e) {
    console.warn('Using fallback semantic DB');
    semanticDB = FALLBACK_SEMANTIC_DB;
    document.getElementById('status').textContent = '‚úÖ Fallback semantic DB active';
  }
}

// üß™ Fallback DB (replace with your 2MB JSON when ready)
const FALLBACK_SEMANTIC_DB = {
  "organic farming": {
    queries: {
      ecological: "organic farming soil health biodiversity regenerative",
      gap: "organic farming challenges India small farmers certification",
      action: "how to start organic home garden beginners step by step"
    },
    actions: ["Visit organic farm", "Start small garden", "Test your soil", "Join seed saving group"]
  },
  "pollution vehicle": {
    queries: {
      ecological: "vehicle pollution air quality health impact emissions",
      gap: "biogas vehicle adoption rural India barriers",
      action: "reduce car pollution daily habits electric transport"
    },
    actions: ["Calculate carbon footprint", "Use public transport", "Join clean air advocacy"]
  },
  "water conservation": {
    queries: {
      ecological: "water conservation rainwater harvesting drought resilience",
      gap: "water scarcity solutions Raichur Karnataka groundwater",
      action: "DIY rooftop rainwater harvesting home setup"
    },
    actions: ["Install rain barrel", "Plant native drought-resistant species", "Fix home leaks"]
  }
};

// üß† Main Search Handler
async function handleSearch() {
  const q = document.getElementById('userQuery').value.trim().toLowerCase();
  if (!q) {
    hideActions();
    return;
  }

  // Step 1: Try ChromaDB
  let match = null;
  try {
    match = await queryChromaDB(q);
  } catch (e) {
    console.debug('ChromaDB not available:', e.message);
  }

  // Step 2: Fall back to semantic JSON
  if (!match) {
    match = semanticDB[q] || findFuzzyMatch(q);
  }

  // Step 3: Generate results
  if (match) {
    showActions(match.actions);
    runThreeSearches(match.queries, q);
  } else {
    // Ultimate fallback
    const basic = { ecological: q, gap: q, action: q };
    showActions(["Explore local resources", "Search community forums"]);
    runThreeSearches(basic, q);
  }
}

// üîç ChromaDB Query (localhost:8000)
async function queryChromaDB(query) {
  const res = await fetch('http://localhost:8000/api/v1/collections/krishi/search', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      query_texts: [query],
      n_results: 1,
      include: ["metadatas"]
    })
  });
  if (!res.ok) throw new Error('Chroma unreachable');
  const data = await res.json();
  return data?.metadatas?.[0]?.[0] || null;
}

// üîç Fuzzy match for unknown terms
function findFuzzyMatch(query) {
  for (const [term, data] of Object.entries(semanticDB)) {
    if (term.split(' ').some(w => query.includes(w))) {
      return data;
    }
  }
  return null;
}

// üéØ UI Functions
function showActions(actions) {
  document.getElementById('actionItems').innerHTML = 
    actions.map(a => `<span class="action-item">${a}</span>`).join('');
  document.getElementById('actionsBox').style.display = 'block';
}

function hideActions() {
  document.getElementById('actionsBox').style.display = 'none';
}

// üîç Perform 3 Searches
function runThreeSearches(queries, originalQuery) {
  const e = encodeURIComponent;
  
  // Ecological
  const ecoQuery = queries.ecological || originalQuery;
  document.getElementById('ecologicalLink').innerHTML = 
    `<a href="https://www.google.com/search?q=${e(ecoQuery)}" target="_blank">${ecoQuery}</a>`;

  // Gap
  const gapQuery = queries.gap || originalQuery;
  document.getElementById('gapLink').innerHTML = 
    `<a href="https://scholar.google.com/scholar?q=${e(gapQuery)}" target="_blank">${gapQuery}</a>`;

  // Action
  const actionQuery = queries.action || originalQuery;
  document.getElementById('actionLink').innerHTML = 
    `<a href="https://www.youtube.com/results?search_query=${e(actionQuery)}" target="_blank">${actionQuery}</a>`;

  // All tab
  document.getElementById('allResults').innerHTML = `
    <div><strong>üå± Ecological:</strong> <a href="https://www.google.com/search?q=${e(ecoQuery)}" target="_blank">${ecoQuery}</a></div>
    <div><strong>üîç Gap:</strong> <a href="https://scholar.google.com/scholar?q=${e(gapQuery)}" target="_blank">${gapQuery}</a></div>
    <div><strong>‚úÖ Action:</strong> <a href="https://www.youtube.com/results?search_query=${e(actionQuery)}" target="_blank">${actionQuery}</a></div>
    <div><strong>üó∫Ô∏è Maps:</strong> <a href="https://www.google.com/maps/search/${e(originalQuery)}" target="_blank">Local resources</a></div>
  `;
}

// üñ±Ô∏è Tab Switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.target).classList.add('active');
  });
});

// ‚ñ∂Ô∏è Initialize
loadSemanticDB();
</script>
</body>
</html>
